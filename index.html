<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistem Absensi Capster</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background-color: #f0f2f5;
        margin: 0;
      }

      .container {
        background-color: #ffffff;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        text-align: center;
        width: 90%;
        max-width: 500px;
      }

      h1 {
        color: #333;
      }

      #status-message {
        font-size: 2em;
        font-weight: bold;
        margin-top: 20px;
        color: #4caf50;
      }

      .status-hadir {
        color: #4caf50;
      }
      .status-terlambat {
        color: #ff9800;
      }
      .status-ditolak {
        color: #f44336;
      }
      .status-error {
        color: #607d8b;
      }

      #keterangan {
        font-size: 1.1em;
        color: #555;
      }

      #store-info {
        color: #888;
        font-style: italic;
      }

      .spinner-border {
        width: 3rem;
        height: 3rem;
        border: 0.25em solid currentColor;
        border-right-color: transparent;
        border-radius: 50%;
        animation: spinner-grow 0.75s linear infinite;
        margin: 50px auto;
        color: #007bff;
      }

      @keyframes spinner-grow {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      select,
      button {
        width: 100%;
        padding: 10px;
        margin-top: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      button {
        background-color: #007bff;
        color: white;
        cursor: pointer;
      }
      #debug-info {
          margin-top: 30px;
          padding: 15px;
          background-color: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
          border-radius: 5px;
          text-align: left;
          font-family: 'Courier New', Courier, monospace;
          white-space: pre-wrap;
          word-wrap: break-word;
          display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Absensi Capster</h1>

      <div
        id="loading-spinner"
        class="spinner-border text-primary"
        role="status"
      >
        <span class="sr-only">Loading...</span>
      </div>

      <div id="form-container" style="display: none">
        <p id="store-info">Sedang memuat data toko...</p>
        <label for="capsterSelect">Pilih Nama Anda:</label>
        <select id="capsterSelect"></select>
        <button id="submitBtn">Kirim Absensi</button>
      </div>

      <div id="status-container" style="display: none">
        <h2 id="status-message"></h2>
        <p id="keterangan"></p>
      </div>

      <div id="debug-info">
        <strong>Hasil Debug:</strong>
        <pre id="debug-content"></pre>
      </div>
    </div>

    <script>
      const WEB_APP_URL =
        "https://script.google.com/macros/s/AKfycbyNmb4Qx0rXqC88oglWp-Cqs2IlJogA7ed7CYasiCw8fNYDCZmZJcLWZ_HS7BertP4OIg/exec";

      document.addEventListener("DOMContentLoaded", () => {
        const urlParams = new URLSearchParams(window.location.search);
        const storeId = urlParams.get("storeId");

        if (storeId) {
          // Fetch store details and capsters list based on storeId
          fetchStoreAndCapstersData(storeId);

          document.getElementById("submitBtn").addEventListener("click", () => {
            processAbsence(storeId);
          });
        } else {
          document.getElementById("store-info").innerText =
            "QR Code tidak valid. Mohon gunakan QR Code khusus untuk absensi.";
          document.getElementById("loading-spinner").style.display = "none";
          document.getElementById("form-container").style.display = "block";
        }
      });

      async function fetchStoreAndCapstersData(storeId) {
        const loadingSpinner = document.getElementById("loading-spinner");
        const formContainer = document.getElementById("form-container");
        const statusContainer = document.getElementById("status-container");
        const debugInfo = document.getElementById("debug-info");
        const debugContent = document.getElementById("debug-content");
        
        loadingSpinner.style.display = "block";
        formContainer.style.display = "none";
        statusContainer.style.display = "none";
        debugInfo.style.display = "none";

        try {
          // Fetching store data
          const storeUrl = `${WEB_APP_URL}?storeId=${storeId}`;
          const storeResponse = await fetch(storeUrl);
          if (!storeResponse.ok) {
            throw new Error(`HTTP error! status: ${storeResponse.status}`);
          }
          const storeData = await storeResponse.json();
          debugContent.textContent += `\n--- Respon Store ---\n${JSON.stringify(storeData, null, 2)}`;
          
          if (storeData.error) {
            throw new Error(storeData.error);
          }

          document.getElementById("store-info").innerText = `Anda akan absen di toko: ${storeData.Nama_Store}`;

          // Fetching capsters data
          const capstersResponse = await fetch(WEB_APP_URL);
          if (!capstersResponse.ok) {
            throw new Error(`HTTP error! status: ${capstersResponse.status}`);
          }
          const capsters = await capstersResponse.json();
          debugContent.textContent += `\n\n--- Respon Capsters ---\n${JSON.stringify(capsters, null, 2)}`;
          
          const selectElement = document.getElementById("capsterSelect");
          if (Array.isArray(capsters) && capsters.length > 0) {
            selectElement.innerHTML = '<option value="">-- Pilih Capster --</option>';
            capsters.forEach((capster) => {
              const option = document.createElement("option");
              option.value = capster.Id;
              option.text = capster.Nama;
              selectElement.appendChild(option);
            });
            loadingSpinner.style.display = "none";
            formContainer.style.display = "block";
          } else {
            selectElement.innerHTML = '<option value="">Tidak ada capster terdaftar.</option>';
            loadingSpinner.style.display = "none";
            formContainer.style.display = "block";
          }
        } catch (error) {
          debugContent.textContent += `\n\n--- Error Ditemukan ---\n${error.message}`;
          document.getElementById("status-container").style.display = "block";
          document.getElementById("status-message").innerText = "Error";
          document.getElementById("keterangan").innerText = "Gagal memuat data toko atau capster. " + error.message;
          loadingSpinner.style.display = "none";
        } finally {
          debugInfo.style.display = "block";
        }
      }

      async function processAbsence(storeId) {
        const formContainer = document.getElementById("form-container");
        const loadingSpinner = document.getElementById("loading-spinner");
        const statusContainer = document.getElementById("status-container");
        const statusMessage = document.getElementById("status-message");
        const keterangan = document.getElementById("keterangan");
        const debugInfo = document.getElementById("debug-info");
        const debugContent = document.getElementById("debug-content");
        
        debugContent.textContent = "Mengirim absensi...";
        debugInfo.style.display = "block";

        const capsterSelect = document.getElementById("capsterSelect");
        const capsterId = capsterSelect.value;
        if (!capsterId) {
          alert("Mohon pilih nama Anda.");
          return;
        }

        const capsterCoords = await getCurrentPosition().catch((error) => {
          alert(error);
          return null;
        });

        if (!capsterCoords) {
          return;
        }

        formContainer.style.display = "none";
        loadingSpinner.style.display = "block";
        statusContainer.style.display = "none";

        try {
          const response = await fetch(WEB_APP_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              storeId: storeId,
              capsterId: capsterId,
              checkinTime: new Date(),
              capsterLat: capsterCoords.latitude,
              capsterLon: capsterCoords.longitude,
            }),
          });

          const result = await response.json();
          debugContent.textContent += `\n\n--- Respon POST ---\n${JSON.stringify(result, null, 2)}`;
          statusMessage.innerText = result.status;
          keterangan.innerText = result.keterangan;
          statusMessage.className = `status-${result.status
            .toLowerCase()
            .replace(/[^a-z0-9]/g, "-")}`;
        } catch (error) {
          console.error("Error:", error);
          debugContent.textContent += `\n\n--- Error POST Ditemukan ---\n${error.message}`;
          statusMessage.innerText = "Error";
          keterangan.innerText =
            "Terjadi kesalahan saat memproses absensi: " + error.message;
          statusMessage.className = "status-error";
        } finally {
          loadingSpinner.style.display = "none";
          statusContainer.style.display = "block";
        }
      }

      function getCurrentPosition() {
        return new Promise((resolve, reject) => {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              (position) => {
                resolve({
                  latitude: position.coords.latitude,
                  longitude: position.coords.longitude,
                });
              },
              (error) => {
                if (error.code === error.PERMISSION_DENIED) {
                  reject(
                    "Akses lokasi ditolak. Absensi gagal karena izin lokasi wajib diberikan."
                  );
                } else {
                  reject("Gagal mendapatkan lokasi: " + error.message);
                }
              }
            );
          } else {
            reject("Geolocation tidak didukung oleh browser ini.");
          }
        });
      }
    </script>
  </body>
</html>
