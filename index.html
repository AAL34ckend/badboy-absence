<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistem Absensi Capster</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background-color: #f0f2f5;
        margin: 0;
      }

      .container {
        background-color: #ffffff;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        text-align: center;
        width: 90%;
        max-width: 500px;
      }

      h1 {
        color: #333;
      }

      #status-message {
        font-size: 2em;
        font-weight: bold;
        margin-top: 20px;
        color: #4caf50;
      }

      .status-hadir {
        color: #4caf50;
      }
      .status-terlambat {
        color: #ff9800;
      }
      .status-ditolak {
        color: #f44336;
      }
      .status-error {
        color: #607d8b;
      }

      #keterangan {
        font-size: 1.1em;
        color: #555;
      }

      #store-info {
        color: #888;
        font-style: italic;
      }

      .spinner-border {
        width: 3rem;
        height: 3rem;
        border: 0.25em solid currentColor;
        border-right-color: transparent;
        border-radius: 50%;
        animation: spinner-grow 0.75s linear infinite;
        margin: 50px auto;
        color: #007bff;
      }

      @keyframes spinner-grow {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      select,
      button {
        width: 100%;
        padding: 10px;
        margin-top: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      button {
        background-color: #007bff;
        color: white;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Absensi Capster</h1>

      <div
        id="loading-spinner"
        class="spinner-border text-primary"
        role="status"
      >
        <span class="sr-only">Loading...</span>
      </div>

      <div id="form-container" style="display: none">
        <p id="store-info">Sedang memuat data toko...</p>
        <label for="capsterSelect">Pilih Nama Anda:</label>
        <select id="capsterSelect"></select>
        <button id="submitBtn">Kirim Absensi</button>
      </div>

      <div id="status-container" style="display: none">
        <h2 id="status-message"></h2>
        <p id="keterangan"></p>
      </div>
    </div>

    <script>
      // Ganti dengan URL web app Google Apps Script Anda
      const WEB_APP_URL =
        "https://script.google.com/macros/s/AKfycbz5S10ON7zjPP21UgVGEka66Ae-j9RzKg6v3RXCH65Ts-2fPGlBJB1bubMLApY1PVM97Q/exec";

      document.addEventListener("DOMContentLoaded", () => {
        const urlParams = new URLSearchParams(window.location.search);
        const storeName = urlParams.get("storeName");

        // Jika storeName ditemukan di URL, tampilkan formulir
        if (storeName) {
          document.getElementById(
            "store-info"
          ).innerText = `Anda akan absen di toko: ${storeName}`;
          fetchCapstersAndPopulateDropdown();

          document.getElementById("submitBtn").addEventListener("click", () => {
            processAbsence();
          });
        } else {
          // Jika tidak ada parameter yang sesuai, berikan pesan error
          document.getElementById("store-info").innerText =
            "QR Code tidak valid. Mohon gunakan QR Code khusus untuk absensi.";
          document.getElementById("loading-spinner").style.display = "none";
          document.getElementById("form-container").style.display = "block";
        }
      });

      async function fetchCapstersAndPopulateDropdown() {
        try {
          const response = await fetch(WEB_APP_URL);
          const capsters = await response.json();

          const selectElement = document.getElementById("capsterSelect");
          if (capsters.length > 0) {
            selectElement.innerHTML =
              '<option value="">-- Pilih Capster --</option>';
            capsters.forEach((capster) => {
              const option = document.createElement("option");
              option.value = capster.id;
              option.text = capster.nama;
              selectElement.appendChild(option);
            });
            document.getElementById("loading-spinner").style.display = "none";
            document.getElementById("form-container").style.display = "block";
          } else {
            selectElement.innerHTML =
              '<option value="">Tidak ada capster terdaftar.</option>';
          }
        } catch (error) {
          document.getElementById("status-container").style.display = "block";
          document.getElementById("status-message").innerText = "Error";
          document.getElementById("keterangan").innerText =
            "Gagal memuat daftar capster. " + error.message;
          document.getElementById("loading-spinner").style.display = "none";
        }
      }

      async function processAbsence() {
        const formContainer = document.getElementById("form-container");
        const loadingSpinner = document.getElementById("loading-spinner");
        const statusContainer = document.getElementById("status-container");
        const statusMessage = document.getElementById("status-message");
        const keterangan = document.getElementById("keterangan");

        const capsterSelect = document.getElementById("capsterSelect");
        const capsterId = capsterSelect.value;
        if (!capsterId) {
          alert("Mohon pilih nama Anda.");
          return;
        }

        formContainer.style.display = "none";
        loadingSpinner.style.display = "block";
        statusContainer.style.display = "none";

        try {
          const urlParams = new URLSearchParams(window.location.search);
          const storeName = urlParams.get("storeName");
          const storeOpenTime = urlParams.get("openTime");
          const storeCloseTime = urlParams.get("closeTime");
          const storeLat = urlParams.get("lat");
          const storeLon = urlParams.get("lon");
          const checkinTime = new Date();
          const capsterCoords = await getCurrentPosition();

          const response = await fetch(WEB_APP_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              storeName: storeName,
              openTime: storeOpenTime,
              closeTime: storeCloseTime,
              storeLat: storeLat,
              storeLon: storeLon,
              capsterId: capsterId,
              checkinTime: checkinTime,
              capsterLat: capsterCoords.latitude,
              capsterLon: capsterCoords.longitude,
            }),
          });

          const result = await response.json();
          statusMessage.innerText = result.status;
          keterangan.innerText = result.keterangan;
          statusMessage.className = `status-${result.status
            .toLowerCase()
            .replace(/[^a-z0-9]/g, "-")}`;
        } catch (error) {
          console.error("Error:", error);
          statusMessage.innerText = "Error";
          keterangan.innerText =
            "Terjadi kesalahan saat memproses absensi: " + error.message;
          statusMessage.className = "status-error";
        } finally {
          loadingSpinner.style.display = "none";
          statusContainer.style.display = "block";
        }
      }

      function getCurrentPosition() {
        return new Promise((resolve, reject) => {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              (position) => {
                resolve({
                  latitude: position.coords.latitude,
                  longitude: position.coords.longitude,
                });
              },
              (error) => {
                reject("Gagal mendapatkan lokasi: " + error.message);
              }
            );
          } else {
            reject("Geolocation tidak didukung oleh browser ini.");
          }
        });
      }
    </script>
  </body>
</html>
